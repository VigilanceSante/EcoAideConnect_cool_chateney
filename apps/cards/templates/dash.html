{% extends layout_path %}

{% block title %}Tableau de Bord - Qualité de l'air{% endblock %}

{% block vendor_css %}
  {{ block.super }}
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/apexcharts/dist/apexcharts.css">
  <style>
    body {
      font-family: 'Roboto', sans-serif;
      background-color: #f0f4f7;
      margin: 0;
      padding: 0;
      color: #333;
    }

    .dashboard-container {
      max-width: 1200px;
      margin: auto;
      padding: 20px;
    }

    .dashboard-header {
      text-align: center;
      font-size: 28px;
      color: #4a90e2;
      margin-bottom: 20px;
      font-weight: 600;
    }

    .info-sections {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      justify-content: space-between;
    }

    .info-card {
      background-color: #fff;
      border-radius: 12px;
      padding: 10px;
      box-shadow: 0px 4px 16px rgba(0, 0, 0, 0.1);
      transition: all 0.3s ease;
      text-align: center;
      flex: 1 1 30%;
    }

    .gauge-container {
      width: 100%;
      height: 150px;
      margin-bottom: 10px;
    }

    .recommendations {
      background-color: #ffe5e5;
      border-left: 4px solid #ff3b30;
      padding: 10px;
      margin-top: 15px;
      font-size: 14px;
      color: #c40000;
      text-align: left;
      border-radius: 6px;
    }

    /* Météo section */
    .weather-section {
      display: flex;
      flex-wrap: wrap;
      justify-content: space-around;
      align-items: center;
      gap: 10px;
    }

    .weather-card {
      flex: 1 1 48%;
      background-color: #fff;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0px 4px 16px rgba(0, 0, 0, 0.1);
      text-align: center;
    }

    .weather-icon {
      font-size: 40px;
      color: #4a90e2;
      margin-bottom: 10px;
    }

    .weather-temp {
      font-size: 28px;
      font-weight: bold;
      color: #333;
    }

    .weather-details {
      font-size: 16px;
      margin-top: 10px;
    }

    /* Pollen section - collapsible */
    .collapsible {
      background-color: #fff;
      color: #333;
      cursor: pointer;
      padding: 10px;
      border: none;
      text-align: left;
      outline: none;
      font-size: 18px;
      margin-bottom: 5px;
      border-radius: 5px;
    }

    .collapsible-content {
      padding: 0 18px;
      display: none;
      overflow: hidden;
      background-color: #f9f9f9;
      border-radius: 5px;
      box-shadow: inset 0px 2px 10px rgba(0, 0, 0, 0.05);
    }

    .collapsible-content ul {
      padding: 10px;
      list-style-type: none;
      margin: 0;
    }

    .collapsible-content ul li {
      margin-bottom: 5px;
      font-size: 16px;
    }
  </style>
{% endblock vendor_css %}

{% block content %}
<div class="dashboard-container">
  <!-- Section Météo -->
  <h2>Météo actuelle</h2>
  <div class="weather-section">
    <div class="weather-card">
      <div class="weather-icon">
        <i class="fas fa-thermometer-half"></i>
      </div>
      <div class="weather-temp">{{ temperature }}°C</div>
      <div class="weather-details">Température ressentie : {{ feel_like }}°C</div>
    </div>

    <div class="weather-card">
      <div class="weather-icon">
        <i class="fas fa-wind"></i>
      </div>
      <div class="weather-temp">{{ wind_speed }} km/h</div>
      <div class="weather-details">Vitesse du vent</div>
    </div>

    <div class="weather-card">
      <div class="weather-icon">
        <i class="fas fa-temperature-high"></i>
      </div>
      <div class="weather-temp">{{ max_temp }}°C</div>
      <div class="weather-details">Température max</div>
    </div>

    <div class="weather-card">
      <div class="weather-icon">
        <i class="fas fa-temperature-low"></i>
      </div>
      <div class="weather-temp">{{ min_temp }}°C</div>
      <div class="weather-details">Température min</div>
    </div>
  </div>

  <!-- Section Pollution avec jauges -->
  <h2>Qualité de l'air</h2>

  <div class="info-sections">
    <!-- Jauge PM10 -->
    <div class="info-card">
      <h6>Particules PM10</h6>
      <div class="gauge-container" id="gauge-pm10"></div>
    </div>

    <!-- Jauge PM2.5 -->
    <div class="info-card">
      <h6>Particules PM2.5</h6>
      <div class="gauge-container" id="gauge-pm25"></div>
    </div>

    <!-- Jauge NO2 -->
    <div class="info-card">
      <h6>NO2</h6>
      <div class="gauge-container" id="gauge-no2"></div>
    </div>

    <!-- Jauge O3 -->
    <div class="info-card">
      <h6>Ozone (O3)</h6>
      <div class="gauge-container" id="gauge-o3"></div>
    </div>

    <!-- Jauge SO2 -->
    <div class="info-card">
      <h6>SO2</h6>
      <div class="gauge-container" id="gauge-so2"></div>
    </div>
  </div>

  <!-- Section Pollens avec collapse -->
  <h2>Niveaux de Pollen</h2>
  <button type="button" class="collapsible">Voir les niveaux de pollen</button>
  <div class="collapsible-content">
    <ul>
      {% for pollen in pollens %}
        <li><strong>{{ pollen.label }} :</strong> {{ pollen.niveau }}</li>
      {% endfor %}
    </ul>
  </div>
</div>
{% endblock %}

{% block vendor_js %}
  {{ block.super }}
  <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>

  <script>
    // Fonction de création d'une jauge avec texte personnalisé
    var createGauge = function(containerId, value, labelText) {
      var options = {
        chart: {
          type: 'radialBar',
          height: 150,
          offsetY: -20,
          sparkline: {
            enabled: true
          }
        },
        plotOptions: {
          radialBar: {
            startAngle: -90,
            endAngle: 90,
            hollow: {
              margin: 0,
              size: '50%',
            },
            track: {
              background: '#e7e7e7',
              strokeWidth: '100%',
              margin: 5,
            },
            dataLabels: {
              showOn: 'always',
              name: {
                show: true,
                fontSize: '16px',
                color: '#333',
                offsetY: -10
              },
              value: {
                fontSize: '18px',
                show: true,
                // Formatter ici pour afficher le texte personnalisé
                formatter: function() {
                  return labelText;  // Utilisation du texte personnalisé ici
                }
              }
            },
          },
        },
        fill: {
          colors: [value < 33 ? '#00E396' : value < 66 ? '#FFA500' : '#FF4560']  // Vert, Orange, Rouge
        },
        series: [value],  // La valeur numérique pour déterminer la couleur
        stroke: {
          lineCap: 'round'
        },
        labels: [labelText]
      };

      var chart = new ApexCharts(document.querySelector(containerId), options);
      chart.render();
    };

    // Créer les jauges avec les bonnes valeurs
    createGauge("#gauge-pm10", {{ PM10_value }}, "{{ PM10_text }}");
    createGauge("#gauge-pm25", {{ PM25_value }}, "{{ PM25_text }}");
    createGauge("#gauge-no2", {{ NO2_value }}, "{{ NO2_text }}");
    createGauge("#gauge-o3", {{ O3_value }}, "{{ O3_text }}");
    createGauge("#gauge-so2", {{ SO2_value }}, "{{ SO2_text }}");

    // Fonction pour le collapse des niveaux de pollen
    var collapsibles = document.querySelectorAll(".collapsible");

    collapsibles.forEach(function(collapsible) {
      collapsible.addEventListener("click", function() {
        this.classList.toggle("active");
        var content = this.nextElementSibling;
        if (content.style.display === "block") {
          content.style.display = "none";
        } else {
          content.style.display = "block";
        }
      });
    });
  </script>
{% endblock %}