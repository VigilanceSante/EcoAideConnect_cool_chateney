{% extends layout_path %}

{% load static %}
{% load i18n %}

{% block title %}CoolChateney{% endblock %}

{% block vendor_css %}
    {{ block.super }}
    <link rel="stylesheet" href="{% static 'vendor/libs/apex-charts/apex-charts.css' %}" />
    <!-- Font Awesome CDN -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <!-- Leaflet MarkerCluster CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.Default.css" />
    <style>
      /* Mobile-first approach */
      body {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        background-color: #f4f7f9;
        color: #333;
        margin: 0;
        padding: 0;
      }

      .container {
        padding: 1rem;
        max-width: 1200px;
        margin: 0 auto;
      }

      .row {
        display: flex;
        flex-wrap: wrap;
        gap: 1rem;
      }

      .card {
        display: flex;
        flex-direction: column;
        border: 1px solid #d9dee3;
        border-radius: 0.5rem;
        box-shadow: 0 2px 6px rgba(67, 89, 113, 0.12);
        background-color: #fff;
        transition: box-shadow 0.3s ease, transform 0.3s ease;
      }

      .card:hover {
        box-shadow: 0 4px 12px rgba(67, 89, 113, 0.2);
        transform: translateY(-4px);
      }

      .card-body {
        padding: 1rem;
        text-align: center;
      }

      .card-title {
        margin-bottom: 0.875rem;
        color: #566a7f;
        font-size: 1.25rem;
      }

      .card-icon {
        font-size: 2rem;
      }

      .alert {
        border-radius: 0.25rem;
        font-size: 0.875rem;
      }

      /* Responsive Design */
      @media (min-width: 576px) {
        .col-md-6 {
          flex: 0 0 50%;
          max-width: 50%;
        }
      }

      @media (min-width: 768px) {
        .col-lg-3 {
          flex: 0 0 25%;
          max-width: 25%;
        }
      }

      /* Improved map styling */
      .map-container {
        height: 500px; /* Increased height for better UX */
        width: 100%;
        border-radius: 8px;
        margin-top: 20px;
      }

      .card {
        border: none;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
      }

      .card-title {
        font-size: 1.5rem;
        font-weight: bold;
        text-align: center;
      }
    </style>
{% endblock vendor_css %}

{% block vendor_js %}
    {{ block.super }}
    <script src="{% static 'vendor/libs/apex-charts/apexcharts.js' %}"></script>
    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <!-- Leaflet MarkerCluster JS -->
    <script src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js"></script>
{% endblock vendor_js %}

{% block page_js %}
    {{ block.super }}
    <script src="{% static 'js/dashboards-analytics.js' %}"></script>
    <script>
      // Initialize the map without specifying center and zoom level
      var map = L.map('map');

      // Add the OpenStreetMap tile layer
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a> contributors',
        maxZoom: 18,
      }).addTo(map);

      // Initialize a marker cluster group
      var markers = L.markerClusterGroup();

      // Function to add a marker to the cluster group
      function addMarker(lat, lng, popupContent) {
        L.marker([lat, lng]).bindPopup(popupContent).addTo(markers);
      }

      // Marker data
      const locations = [
        { lat: 48.7606, lng: 2.2589, content: 'Centre Communal d’Action Sociale (26 rue du Docteur Le Savoureux), 01 46 83 46 82' },
        { lat: 48.765820958051215, lng: 2.259873405997262, content: 'Cinéma Le Rex (364 avenue de la Division Leclerc), 01 40 83 16 85' },
        { lat: 48.76464287485584, lng: 2.2799412458230184, content: 'Espace Séniors (291-293 avenue de la Division Leclerc), 01 46 32 46 69' },
        { lat: 48.7576, lng: 2.2579, content: 'Médiathèque (7-9 rue des Vallées), 01 46 83 45 48' },
        { lat: 48.7672137222992, lng: 2.279124161043493, content: 'Pavillon des Arts et du Patrimoine (98 rue Jean Longuet), 01 47 02 75 22' },
        { lat: 48.7677830136355, lng: 2.2891088215439126, content: 'Coulée Verte, avenue Sully Prudhomme (point d’eau potable)' },
        { lat: 48.77409876009363, lng: 2.2691806285229026, content: 'Jardin de l’Aigle Blanc, rue de Chateaubriand (point d’eau potable)' },
        { lat: 48.766645965325324, lng: 2.2892076709756704, content: 'Quartier LaVallée, jardins LaVallée (point d’eau potable)' },
        { lat: 48.769947175285594, lng: 2.2803509895275607, content: 'Centre-ville, rue Jean Longuet (fontaine publique d’eau non potable)' },
      ];

      // Bounds object to calculate the extent of all markers
      var bounds = new L.LatLngBounds();

      // Add all markers to the map and extend bounds
      locations.forEach(location => {
        addMarker(location.lat, location.lng, location.content);
        bounds.extend([location.lat, location.lng]); // Extend bounds for each marker
      });

      // Add the marker cluster group to the map
      map.addLayer(markers);

      // Fit the map view to the bounds of all markers
      map.fitBounds(bounds);
    </script>
{% endblock page_js %}

{% block content %}
    <div class="container">
      <!-- Welcome Card -->
      <div class="row mb-4">
        <div class="col-12">
          <div class="card">
            <div class="card-body">
              <h5 class="card-title text-primary">Bienvenue sur CoolChateney !</h5>
              <p class="mb-3">
                <span class="h1 font-weight-bold">{{ weather_data.temperature }}&deg;C</span>
                <br>
                <small class="{{ weather_data.description_class }} text-muted">{{ weather_data.description }}</small>
              </p>
              <p>
                <span class="d-block mb-1"><i class="fas fa-thermometer-three-quarters"></i> Température maximale : <span class="{{ weather_data.max_temp_class }}">{{ weather_data.max_temp }}&deg;C</span></span>
                <span class="d-block"><i class="fas fa-thermometer-quarter"></i> Température minimale : <span class="{{ weather_data.min_temp_class }}">{{ weather_data.min_temp }}&deg;C</span></span>
                <!-- Indice de pollution -->
                <span class="d-block"><i class="fas fa-smog"></i> Indice de pollution : <span class="{{ pollution_data }}">{{ pollution_data.level }}</span></span>
              </p>
              <div class="alert alert-info mt-3" role="alert">
                {{ weather_data.advice }}
              </div>
              <p class="mt-3">
                Profitez de votre journée !
              </p>
            </div>
          </div>
        </div>
      </div>

      <!-- OpenStreetMap -->
      <div class="row">
        <div class="col-12">
          <div class="card">
            <div class="card-body">
              <h5 class="card-title text-primary">Découvrir les lieux frais</h5>
              <div id="map" class="map-container"></div>
            </div>
          </div>
        </div>
      </div>
    </div>
{% endblock %}