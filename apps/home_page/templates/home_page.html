{% extends layout_path %}

{% load static %}
{% load i18n %}

{% block title %}CoolChateney{% endblock %}

{% block vendor_css %}
    {{ block.super }}
    <link rel="stylesheet" href="{% static 'vendor/libs/apex-charts/apex-charts.css' %}" />
    <!-- Font Awesome CDN -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <!-- Leaflet MarkerCluster CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.Default.css" />
    <style>
      /* Variables de couleur pour cohérence visuelle */
      :root {
        --primary-color: #4a90e2; /* Couleur principale */
        --accent-color: #f5a623; /* Couleur d'accentuation */
        --background-color: #f4f7f9; /* Fond général */
        --text-color: #333; /* Texte principal */
        --warning-color: #f56c42; /* Couleur alerte */
      }

      body {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        background-color: var(--background-color);
        color: var(--text-color);
        margin: 0;
        padding: 0;
      }

      .container {
        padding: 1rem;
        margin: 0 auto;
        max-width: 100%;
      }

      /* Style de la carte météo/qualité de l'air */
      .card {
        background-color: white;
        border-radius: 8px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.05);
        margin-bottom: 1rem;
        padding: 1.5rem;
        transition: box-shadow 0.3s ease, transform 0.3s ease;
      }

      .card:hover {
        box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1);
        transform: translateY(-4px);
      }

      .card-title {
        font-size: 1.4rem;
        font-weight: 600;
        color: var(--primary-color);
        margin-bottom: 1rem;
      }

      .alert {
        background-color: var(--warning-color);
        color: white;
        font-size: 1rem;
        padding: 0.8rem;
        border-radius: 0.5rem;
      }

      /* Bloc météo et température */
      .weather-block {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 1rem;
        background-color: var(--background-color);
        border-radius: 1rem;
        margin-bottom: 1rem;
      }

      .weather-info {
        font-size: 1.2rem;
        font-weight: 500;
        color: var(--primary-color);
      }

      .temperature {
        font-size: 2.5rem;
        font-weight: 700;
        color: var(--accent-color);
      }

      .weather-icon {
        font-size: 3rem;
        color: #6bb5f2;
      }

      /* Indicateurs de qualité de l'air */
      .air-quality {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 1rem;
        background-color: #f0f0f0;
        border-radius: 1rem;
      }

      .air-index {
        font-size: 2rem;
        font-weight: bold;
      }

      .index-description {
        font-size: 1rem;
        color: var(--text-color);
      }

      /* Couleurs dynamiques selon la qualité de l'air */
      .air-index.good {
        color: #6bcf48;
      }

      .air-index.moderate {
        color: #f7b500;
      }

      .air-index.bad {
        color: #f44336;
      }

      /* Style de la carte Leaflet */
      .map-container {
        height: 450px;
        width: 100%;
        border-radius: 12px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        margin-top: 20px;
      }

      /* Navigation fixe en bas */
      .bottom-nav {
        display: flex;
        justify-content: space-around;
        background-color: white;
        box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.05);
        padding: 1rem 0;
        position: fixed;
        width: 100%;
        bottom: 0;
      }

      .nav-icon {
        text-align: center;
        color: var(--primary-color);
        font-size: 1.2rem;
      }

      .nav-icon:hover {
        color: var(--accent-color);
      }

      /* Animation et transition */
      .fade-in {
        animation: fadeIn 1s ease-in-out;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
        }
        to {
          opacity: 1;
        }
      }
    </style>
{% endblock vendor_css %}

{% block vendor_js %}
    {{ block.super }}
    <script src="{% static 'vendor/libs/apex-charts/apexcharts.js' %}"></script>
    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <!-- Leaflet MarkerCluster JS -->
    <script src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js"></script>
{% endblock vendor_js %}

{% block page_js %}
    {{ block.super }}
    <script src="{% static 'js/dashboards-analytics.js' %}"></script>
    <script>
      // Initialisation de la carte Leaflet
      var map = L.map('map');

      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a> contributors',
        maxZoom: 18,
      }).addTo(map);

      var markers = L.markerClusterGroup();

      function addMarker(lat, lng, popupContent) {
        L.marker([lat, lng]).bindPopup(popupContent).addTo(markers);
      }

      const locations = [
        { lat: 48.7606, lng: 2.2589, content: 'Centre Communal d’Action Sociale (26 rue du Docteur Le Savoureux)' },
        { lat: 48.765820958051215, lng: 2.259873405997262, content: 'Cinéma Le Rex (364 avenue de la Division Leclerc)' },
        { lat: 48.76464287485584, lng: 2.2799412458230184, content: 'Espace Séniors (291-293 avenue de la Division Leclerc)' },
        { lat: 48.7576, lng: 2.2579, content: 'Médiathèque (7-9 rue des Vallées)' },
        { lat: 48.7672137222992, lng: 2.279124161043493, content: 'Pavillon des Arts et du Patrimoine (98 rue Jean Longuet)' },
        { lat: 48.7677830136355, lng: 2.2891088215439126, content: 'Coulée Verte, avenue Sully Prudhomme' },
        { lat: 48.77409876009363, lng: 2.2691806285229026, content: 'Jardin de l’Aigle Blanc, rue de Chateaubriand' },
      ];

      var bounds = new L.LatLngBounds();

      locations.forEach(location => {
        addMarker(location.lat, location.lng, location.content);
        bounds.extend([location.lat, location.lng]);
      });

      map.addLayer(markers);
      map.fitBounds(bounds);

      // ApexCharts pour les graphiques interactifs
      var options = {
        chart: {
          type: 'line',
          height: 350
        },
        series: [{
          name: 'Qualité de l\'air',
          data: [22, 30, 45, 55, 33, 42, 52]
        }],
        xaxis: {
          categories: ['Lun', 'Mar', 'Mer', 'Jeu', 'Ven', 'Sam', 'Dim']
        },
        colors: ['#f56c42'],
        stroke: {
          curve: 'smooth'
        }
      };

      var chart = new ApexCharts(document.querySelector("#air-quality-chart"), options);
      chart.render();
    </script>
{% endblock page_js %}

{% block content %}
    <div class="container">
      <!-- Carte de bienvenue et météo -->
      <div class="row mb-4 fade-in">
        <div class="col-12">
          <div class="card">
            <div class="card-body">
              <h5 class="card-title">Bienvenue sur CoolChateney !</h5>
              <div class="weather-block">
                <div class="weather-info">
                  <i class="fas fa-sun weather-icon"></i>
                  <p>Météo actuelle : {{ weather_data.description }}</p>
                </div>
                <div class="temperature">
                  {{ weather_data.temperature }}&deg;C
                </div>
              </div>
              <p>
                <span><i class="fas fa-thermometer-three-quarters"></i> Température max : {{ weather_data.max_temp }}&deg;C</span><br>
                <span><i class="fas fa-thermometer-quarter"></i> Température min : {{ weather_data.min_temp }}&deg;C</span><br>
                <span><i class="fas fa-smog"></i> Indice de pollution : {{ pollution_data.overall_index }}</span>
              </p>
              <div class="alert">
                {{ weather_data.advice }}
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Qualité de l'air -->
      <div class="row fade-in">
        <div class="col-12">
          <div class="card">
            <div class="card-body">
              <h5 class="card-title">Qualité de l'air</h5>
              <div class="air-quality">
                <div class="air-index {{ pollution_data.class }}">
                  {{ pollution_data.overall_index }}
                </div>
                <div class="index-description">
                  {{ pollution_data.description }}
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Graphique interactif de la qualité de l'air -->
      <div class="row fade-in">
        <div class="col-12">
          <div class="card">
            <div class="card-body">
              <h5 class="card-title">Évolution de la qualité de l'air</h5>
              <div id="air-quality-chart"></div>
            </div>
          </div>
        </div>
      </div>

      <!-- Carte des lieux frais -->
      <div class="row fade-in">
        <div class="col-12">
          <div class="card">
            <div class="card-body">
              <h5 class="card-title">Découvrir les lieux frais</h5>
              <div id="map" class="map-container"></div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Barre de navigation en bas de l'écran -->
    <nav class="bottom-nav">
      <a href="#" class="nav-icon"><i class="fas fa-cloud-sun"></i><span>Météo</span></a>
      <a href="#" class="nav-icon"><i class="fas fa-smog"></i><span>Qualité de l'air</span></a>
      <a href="#" class="nav-icon"><i class="fas fa-leaf"></i><span>Pollen</span></a>
    </nav>
{% endblock %}