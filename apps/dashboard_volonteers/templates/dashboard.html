{% extends layout_path %}

{% load static %}
{% load i18n %}
{% load availability_tags %}

{% block title %}CoolChateney Dashboard{% endblock %}

{% block vendor_css %}
{{ block.super }}
<link rel="stylesheet" href="{% static 'vendor/libs/apex-charts/apex-charts.css' %}" />
{% endblock vendor_css %}

{% block vendor_js %}
{{ block.super }}
<script src="{% static 'vendor/libs/apex-charts/apexcharts.js' %}"></script>
{% endblock vendor_js %}

{% block page_js %}
{{ block.super }}
<script src="{% static 'js/dashboards-analytics.js' %}"></script>
<script>
document.addEventListener('DOMContentLoaded', function () {
  // Contacts par Date de Début
  var optionsStartDate = {
    chart: {
      type: 'bar',
      height: 350
    },
    series: [{
      name: 'Contacts',
      data: [
        {% for item in contacts_by_start_date %}
          { x: '{{ item.start_date }}', y: {{ item.count }} },
        {% endfor %}
      ]
    }],
    xaxis: {
      type: 'datetime'
    },
    title: {
      text: 'Contacts par Date de Début'
    }
  };
  var chartStartDate = new ApexCharts(document.querySelector("#chart-start-date"), optionsStartDate);
  chartStartDate.render();

  // Contacts par Date de Fin
  var optionsEndDate = {
    chart: {
      type: 'bar',
      height: 350
    },
    series: [{
      name: 'Contacts',
      data: [
        {% for item in contacts_by_end_date %}
          { x: '{{ item.end_date }}', y: {{ item.count }} },
        {% endfor %}
      ]
    }],
    xaxis: {
      type: 'datetime'
    },
    title: {
      text: 'Contacts par Date de Fin'
    }
  };
  var chartEndDate = new ApexCharts(document.querySelector("#chart-end-date"), optionsEndDate);
  chartEndDate.render();

  // Contacts par Disponibilité
  var optionsAvailability = {
    chart: {
      type: 'bar',
      height: 350
    },
    series: [{
      name: 'Contacts',
      data: [
        {% for field, count in availability_counts.items %}
          { x: '{{ field|replace_underscore }}', y: {{ count }} },
        {% endfor %}
      ]
    }],
    xaxis: {
      categories: [
        {% for field in availability_counts.keys %}
          '{{ field|replace_underscore }}',
        {% endfor %}
      ]
    },
    title: {
      text: 'Contacts par Disponibilité'
    }
  };
  var chartAvailability = new ApexCharts(document.querySelector("#chart-availability"), optionsAvailability);
  chartAvailability.render();

  // Meilleurs contributeurs
  var optionsTopContributors = {
    chart: {
      type: 'bar',
      height: 350
    },
    series: [{
      name: 'Contributions',
      data: [
        {% for contributor in top_contributors %}
          { x: '{{ contributor.first_name }} {{ contributor.last_name }}', y: {{ contributor.contributions }} },
        {% endfor %}
      ]
    }],
    xaxis: {
      categories: [
        {% for contributor in top_contributors %}
          '{{ contributor.first_name }} {{ contributor.last_name }}',
        {% endfor %}
      ]
    },
    title: {
      text: 'Meilleurs Contributeurs'
    }
  };
  var chartTopContributors = new ApexCharts(document.querySelector("#chart-top-contributors"), optionsTopContributors);
  chartTopContributors.render();
});
</script>
{% endblock page_js %}

{% block content %}
<div class="container">
  <!-- Filtres -->
  <div class="row mb-4">
    <div class="col-12">
      <div class="card">
        <div class="card-body">
          <h5 class="card-title text-primary">Filtres</h5>
          <form method="GET">
            <div class="row">
              <div class="col-md-4">
                <label for="start-date-filter">Date de Début</label>
                <input type="date" id="start-date-filter" name="start_date" class="form-control" value="{{ request.GET.start_date }}">
              </div>
              <div class="col-md-4">
                <label for="end-date-filter">Date de Fin</label>
                <input type="date" id="end-date-filter" name="end_date" class="form-control" value="{{ request.GET.end_date }}">
              </div>
              <div class="col-md-4">
                <label for="availability-filter">Disponibilité</label>
                <select id="availability-filter" name="availability" class="form-control">
                  <option value="">Toutes</option>
                  {% for field in availability_counts.keys %}
                    <option value="{{ field }}" {% if request.GET.availability == field %}selected{% endif %}>{{ field|replace_underscore }}</option>
                  {% endfor %}
                </select>
              </div>
            </div>
            <div class="row mt-3">
              <div class="col-12">
                <button type="submit" class="btn btn-primary">Appliquer</button>
              </div>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>

  <!-- Total Contacts Card -->
  <div class="row mb-4">
    <div class="col-12 col-md-6 col-lg-3">
      <div class="card">
        <div class="card-body">
          <h5 class="card-title text-primary">Total Contacts</h5>
          <p class="mb-3">
            <span class="h1 font-weight-bold">{{ total_contacts }}</span>
          </p>
        </div>
      </div>
    </div>

    <!-- Tuiles de statistiques -->
    <div class="col-12 col-md-6 col-lg-3">
      <div class="card">
        <div class="card-body">
          <h5 class="card-title text-primary">Nouveaux Contacts (Dernière Semaine)</h5>
          <p class="mb-3">
            <span class="h1 font-weight-bold">{{ new_contacts_last_week }}</span>
          </p>
        </div>
      </div>
    </div>

    <div class="col-12 col-md-6 col-lg-3">
      <div class="card">
        <div class="card-body">
          <h5 class="card-title text-primary">Nouveaux Contacts (Dernier Mois)</h5>
          <p class="mb-3">
            <span class="h1 font-weight-bold">{{ new_contacts_last_month }}</span>
          </p>
        </div>
      </div>
    </div>
  </div>

  <!-- Chart for Contacts by Start Date -->
  <div class="row mb-4">
    <div class="col-12">
      <div class="card">
        <div class="card-body">
          <h5 class="card-title text-primary">Contacts par Date de Début</h5>
          <div id="chart-start-date"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Chart for Contacts by End Date -->
  <div class="row mb-4">
    <div class="col-12">
      <div class="card">
        <div class="card-body">
          <h5 class="card-title text-primary">Contacts par Date de Fin</h5>
          <div id="chart-end-date"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Chart for Contacts by Availability -->
  <div class="row mb-4">
    <div class="col-12">
      <div class="card">
        <div class="card-body">
          <h5 class="card-title text-primary">Contacts par Disponibilité</h5>
          <div id="chart-availability"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Chart for Top Contributors -->
  <div class="row mb-4">
    <div class="col-12">
      <div class="card">
        <div class="card-body">
          <h5 class="card-title text-primary">Meilleurs Contributeurs</h5>
          <div id="chart-top-contributors"></div>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}
