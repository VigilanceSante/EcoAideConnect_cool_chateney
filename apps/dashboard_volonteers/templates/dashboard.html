{% extends layout_path %}

{% load static %}
{% load i18n %}

{% block title %}CoolChatenay Dashboard Amélioré{% endblock %}

{% block vendor_css %}
{{ block.super }}
<link rel="stylesheet" href="{% static 'vendor/libs/apex-charts/apex-charts.css' %}" />
<style>
  .card.equal-height {
    display: flex;
    flex-direction: column;
    height: 100%;
  }
  .card-body {
    flex: 1;
    display: flex;
    flex-direction: column;
    justify-content: center;
  }
  .row {
    margin: 0;
  }
  .col-lg-4 {
    padding: 0.5rem;
  }
  .modal-content {
    padding: 20px;
  }
</style>
{% endblock vendor_css %}

{% block vendor_js %}
{{ block.super }}
<script src="{% static 'vendor/libs/apex-charts/apexcharts.js' %}"></script>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
{% endblock vendor_js %}

{% block page_js %}
{{ block.super }}
<script>
document.addEventListener('DOMContentLoaded', function () {
    var dates = {{ dates|safe }};
    var contactsByDatesSlotsVolunteers = JSON.parse('{{ contacts_by_dates_slots_volunteers|escapejs }}');
    var contactsByDatesSlotsSeekers = JSON.parse('{{ contacts_by_dates_slots_seekers|escapejs }}');

    // Graphique de disponibilité des volontaires pour les 14 prochains jours
    var optionsAvailabilityVolunteers = {
        chart: {
            type: 'bar',
            stacked: true,
            height: 350
        },
        series: [{
            name: 'Toute la journée',
            data: dates.map(date => contactsByDatesSlotsVolunteers[date]['all_day']),
            color: '#4CAF50'
        }, {
            name: 'Matin',
            data: dates.map(date => contactsByDatesSlotsVolunteers[date]['morning']),
            color: '#FFC107'
        }, {
            name: 'Après-midi',
            data: dates.map(date => contactsByDatesSlotsVolunteers[date]['afternoon']),
            color: '#03A9F4'
        }, {
            name: 'Soirée',
            data: dates.map(date => contactsByDatesSlotsVolunteers[date]['evening']),
            color: '#9C27B0'
        }],
        xaxis: {
            categories: dates
        },
        tooltip: {
            y: {
                formatter: function (val) {
                    return val + " personnes";
                }
            }
        }
    };
    var chartAvailabilityVolunteers = new ApexCharts(document.querySelector("#chart-availability-volunteers"), optionsAvailabilityVolunteers);
    chartAvailabilityVolunteers.render();

    // Graphique de disponibilité des seekers pour les 14 prochains jours
    var optionsAvailabilitySeekers = {
        chart: {
            type: 'bar',
            stacked: true,
            height: 350
        },
        series: [{
            name: 'Toute la journée',
            data: dates.map(date => contactsByDatesSlotsSeekers[date]['all_day']),
            color: '#FF5722'  // Couleur différente pour les seekers
        }, {
            name: 'Matin',
            data: dates.map(date => contactsByDatesSlotsSeekers[date]['morning']),
            color: '#FFC107'
        }, {
            name: 'Après-midi',
            data: dates.map(date => contactsByDatesSlotsSeekers[date]['afternoon']),
            color: '#03A9F4'
        }, {
            name: 'Soirée',
            data: dates.map(date => contactsByDatesSlotsSeekers[date]['evening']),
            color: '#9C27B0'
        }],
        xaxis: {
            categories: dates
        },
        tooltip: {
            y: {
                formatter: function (val) {
                    return val + " personnes";
                }
            }
        }
    };
    var chartAvailabilitySeekers = new ApexCharts(document.querySelector("#chart-availability-seekers"), optionsAvailabilitySeekers);
    chartAvailabilitySeekers.render();

    // Graphique Répartition des Volontaires : Semaine vs Week-end
    var weekdayVolunteersCount = {{ weekday_volunteers_count }};
    var weekendVolunteersCount = {{ weekend_volunteers_count }};
    var optionsWeekdayWeekendVolunteers = {
        chart: {
            type: 'pie',
            height: 350
        },
        series: [weekdayVolunteersCount, weekendVolunteersCount],
        labels: ['Semaine', 'Week-end'],
        title: {
            text: 'Répartition des Volontaires : Semaine vs Week-end'
        }
    };
    var chartWeekdayWeekendVolunteers = new ApexCharts(document.querySelector("#chart-weekday-weekend"), optionsWeekdayWeekendVolunteers);
    chartWeekdayWeekendVolunteers.render();

    // Graphique Répartition des Seekers : Semaine vs Week-end
    var weekdaySeekersCount = {{ weekday_seekers_count }};
    var weekendSeekersCount = {{ weekend_seekers_count }};
    var optionsWeekdayWeekendSeekers = {
        chart: {
            type: 'pie',
            height: 350
        },
        series: [weekdaySeekersCount, weekendSeekersCount],
        labels: ['Semaine', 'Week-end'],
        title: {
            text: 'Répartition des Seekers : Semaine vs Week-end'
        }
    };
    var chartWeekdayWeekendSeekers = new ApexCharts(document.querySelector("#chart-seekers-weekday-weekend"), optionsWeekdayWeekendSeekers);
    chartWeekdayWeekendSeekers.render();

    // Graphique Meilleurs Contributeurs
    var optionsTopContributors = {
        chart: {
            type: 'bar',
            height: 350
        },
        series: [{
            name: 'Total Jours',
            data: [
                {% for contributor in top_contributors %}
                    { x: '{{ contributor.first_name }} {{ contributor.last_name }}', y: {{ contributor.total_days.days }} },
                {% endfor %}
            ]
        }],
        title: {
            text: 'Meilleurs Contributeurs'
        },
        xaxis: {
            categories: [
                {% for contributor in top_contributors %}
                    '{{ contributor.first_name }} {{ contributor.last_name }}',
                {% endfor %}
            ]
        },
        tooltip: {
            y: {
                formatter: function (val) {
                    return val + " jours";
                }
            }
        }
    };
    var chartTopContributors = new ApexCharts(document.querySelector("#chart-top-contributors"), optionsTopContributors);
    chartTopContributors.render();
});
</script>
{% endblock page_js %}

{% block content %}
<div class="container">
  <!-- Filtres -->
  <div class="row mb-4">
    <div class="col-12">
      <div class="card">
        <div class="card-body">
          <h5 class="card-title text-primary">Filtres</h5>
          <form method="GET">
            <div class="row">
              <div class="col-md-4">
                <label for="start-date-filter">Date de Début</label>
                <input type="date" id="start-date-filter" name="start_date" class="form-control" value="{{ start_date }}">
              </div>
              <div class="col-md-4">
                <label for="end-date-filter">Date de Fin</label>
                <input type="date" id="end-date-filter" name="end_date" class="form-control" value="{{ end_date }}">
              </div>
            </div>
            <div class="row mt-3">
              <div class="col-12">
                <button type="submit" class="btn btn-primary">Appliquer</button>
              </div>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>

  <!-- KPI Row -->
  <div class="row mb-4">
    <!-- Nombre total de volontaires actifs -->
    <div class="col-12 col-md-6 col-lg-4">
      <div class="card equal-height">
        <div class="card-body">
          <h5 class="card-title text-primary">Nombre total de volontaires actifs</h5>
          <p class="mb-3">
            <span class="h1 font-weight-bold">{{ total_active_volunteers }}</span>
          </p>
        </div>
      </div>
    </div>

    <!-- Nombre total de Seekers -->
    <div class="col-12 col-md-6 col-lg-4">
      <div class="card equal-height">
        <div class="card-body">
          <h5 class="card-title text-primary">Nombre total de Seekers</h5>
          <p class="mb-3">
            <span class="h1 font-weight-bold">{{ total_seekers }}</span>
          </p>
        </div>
      </div>
    </div>

    <!-- Volontaires disponibles le week-end -->
    <div class="col-12 col-md-6 col-lg-4">
      <div class="card equal-height">
        <div class="card-body">
          <h5 class="card-title text-primary">Volontaires disponibles le week-end</h5>
          <p class="mb-3">
            <span class="h1 font-weight-bold">{{ weekend_volunteers_count }}</span>
          </p>
        </div>
      </div>
    </div>

    <!-- Seekers disponibles le week-end -->
    <div class="col-12 col-md-6 col-lg-4">
      <div class="card equal-height">
        <div class="card-body">
          <h5 class="card-title text-primary">Seekers disponibles le week-end</h5>
          <p class="mb-3">
            <span class="h1 font-weight-bold">{{ weekend_seekers_count }}</span>
          </p>
        </div>
      </div>
    </div>

    <!-- Nombre de personnes réinscrites -->
    <div class="col-12 col-md-6 col-lg-4">
      <div class="card equal-height">
        <div class="card-body">
          <h5 class="card-title text-primary">Nombre de personnes réinscrites</h5>
          <p class="mb-3">
            <span class="h1 font-weight-bold">{{ re_registered_volunteers_count }}</span>
          </p>
        </div>
      </div>
    </div>

    <!-- Nombre de binômes créés pendant la période -->
    <div class="col-12 col-md-6 col-lg-4">
      <div class="card equal-height">
        <div class="card-body">
          <h5 class="card-title text-primary">Nombre de binômes créés pendant la période</h5>
          <p class="mb-3">
            <span class="h1 font-weight-bold">{{ pairings_created_count }}</span>
          </p>
        </div>
      </div>
    </div>
  </div>

  <!-- Disponibilité pour les 14 prochains jours ou pendant la période -->
  {% if not total_volunteers_available_period %}
  <div class="row mb-4">
    <!-- Disponibilité des volontaires pour les 14 prochains jours -->
    <div class="col-12">
      <div class="card">
        <div class="card-body">
          <h5 class="card-title text-primary">Volontaires disponibles pour les 14 prochains jours</h5>
          <div id="chart-availability-volunteers"></div>
        </div>
      </div>
    </div>

    <!-- Disponibilité des seekers pour les 14 prochains jours -->
    <div class="col-12">
      <div class="card">
        <div class="card-body">
          <h5 class="card-title text-primary">Seekers disponibles pour les 14 prochains jours</h5>
          <div id="chart-availability-seekers"></div>
        </div>
      </div>
    </div>
  </div>
  {% else %}
  <div class="row mb-4">
    <!-- Volontaires disponibles pendant la période -->
    <div class="col-12">
      <div class="card">
        <div class="card-body">
          <h5 class="card-title text-primary">Volontaires disponibles pendant la période</h5>
          <p class="h1 font-weight-bold">{{ total_volunteers_available_period }}</p>
        </div>
      </div>
    </div>
  </div>
  {% endif %}

  <!-- Répartition des Volontaires et Seekers : Semaine vs Week-end -->
  <div class="row mb-4">
    <!-- Répartition des Volontaires : Semaine vs Week-end -->
    <div class="col-12">
      <div class="card">
        <div class="card-body">
          <h5 class="card-title text-primary">Répartition des Volontaires : Semaine vs Week-end</h5>
          <div id="chart-weekday-weekend"></div>
        </div>
      </div>
    </div>

    <!-- Répartition des Seekers : Semaine vs Week-end -->
    <div class="col-12">
      <div class="card">
        <div class="card-body">
          <h5 class="card-title text-primary">Répartition des Seekers : Semaine vs Week-end</h5>
          <div id="chart-seekers-weekday-weekend"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Meilleurs Contributeurs -->
  <div class="row mb-4">
    <div class="col-12">
      <div class="card">
        <div class="card-body">
          <h5 class="card-title text-primary">Meilleurs Contributeurs</h5>
          <div id="chart-top-contributors"></div>
          <table class="table table-striped mt-4">
            <thead>
              <tr>
                <th scope="col">#</th>
                <th scope="col">Prénom</th>
                <th scope="col">Nom</th>
                <th scope="col">Jours Totaux</th>
              </tr>
            </thead>
            <tbody>
              {% for contributor in top_contributors %}
                <tr>
                  <th scope="row">{{ forloop.counter }}</th>
                  <td>{{ contributor.first_name }}</td>
                  <td>{{ contributor.last_name }}</td>
                  <td>{{ contributor.total_days.days }}</td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}